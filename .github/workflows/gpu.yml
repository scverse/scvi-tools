name: test-gpu

on:
    workflow_dispatch:
        inputs:
            logLevel:
                description: "Log level"
                required: true
                default: "warning"
                type: choice
                options:
                    - info
                    - warning
                    - debug

jobs:
    test:
        runs-on: [self-hosted, Linux, X64, CUDA]
        container:
            image: martinkim0/scvi-tools:11.8
            env:
                MAMBA_DOCKERFILE_ACTIVATE: 1
            options: --user root --gpus all

        steps:
            - uses: actions/checkout@v3
            - name: Activate test environment
              run: |
                  micromamba activate base
            - name: Install dependencies
              run: |
                  pip install ".[dev,pymde,autotune,hub]"
            - name: Test
              env:
                  MPLBACKEND: agg
                  PLATFORM: ubuntu
                  DISPLAY: :42
              run: |
                  pytest -v --cov --color=yes --cuda
            - name: Upload coverage
              uses: codecov/codecov-action@v3
